---
title: "L1 post-taxonomic harmonization subset to Canada/AK/CONUS"
author: 
  - Phoebe L. Zarnetske
  - Patrick Bills
format:
  html:
    toc: true
    toc-depth: 3
    embed-resources: true
editor: source
date: 11/06/2025
date-format: iso
---

## Avian Interaction Pairs Data: L1 to regional subset for Canada/Alaska/CONUS

### About

- **PROJECT:** Avian Interaction Database (CONUS/Canada/AK) and MetaNetwork
- **COLLABORATORS:** Vincent Miele, Stephane Dray
- **Run Date:** `r Sys.Date()`

### Data inputs:

**Avian Interaction Database L0**

Raw Data, combined (stitched) and with content
cleaning but taxonomic names as entered (older names, typos, etc)

*Set the interactions L1 database file to read from here:*


( output From `R/L1/AvianInteractionData_L1.R` )

```{r}
# Clear all existing data
rm(list=ls())

AvianInteractionData_L1_file <-  "ain_all.csv"

```

**Main Checklists:**

Curated Species checklist: 

- Current selected species list for Canada/Alaska/CONUS =
  combined checklist based on Clements/eBird v2024, Avibase v8.17, BBS v2024:
 ( output via Working repo, from `R/L1/3_subset_species_lists.R` ) = spp_joint_cac_colsubset.csv



### DATA OUTPUT:

L1 Canada, Alaska, CONUS species from L1 Avian Interaction Database 
  (`ain_all.csv`); saved as:

```{r}
AvianInteractionData_CanadaAKCONUS_L1_file <- "ain_cac.csv"
AvianInteractionData_CanadaAKCONUS_breeding_file <- "ain_cac_breeding.csv"
AvianInteractionData_L1_not_CanadaAKCONUS_file <- 
  "ain_notcac.csv"
today_date_string <- format(Sys.Date(),"%Y-%m-%d")

```


### Next script to run: 

- depends on project: 
  - for Avian Interaction Database North America (Data Paper): a summary and 
  figure-generating script (to be written)
  - for Avian MetaNetwork Analysis: https://github.com/SpaCE-Lab-MSU/avian-meta-network/tree/main/R/L2


### NOTES

This script is used to subset out only the species that occur in CONUS+Alaska+Canada plus some minor cleaning for the North American subset publication.  


## Data Set-up

File paths used for this run:

```{r}
#| echo: false

# functions used by all 
source(here::here('R/L0/X_functions.R'))
# functions for this process to reduce this script size
# and load libraries used here
source(here::here('R/L1/taxonomy_functions.R'))

file_paths <- get_file_paths()

print(file_paths)
```

*Note that the Checklist folder above is in L0 which contains raw species lists, 
but the Canada/Alaska/CONUS L1 Checklist is the one to use here because it is 
built from multiple L0 lists*


### Setup: Checklists

#### Curated List

October 2025: new curated list curated by PLZ using Clements, AviBase, BBS etc. 
See `R/L1/3_subset_species_lists.R`

```{r}

current_species_list_filename <- "spp_joint_cac_colsubset.csv"
splist_filepath <- file.path(file_paths$CHECKLIST_L1, current_species_list_filename )
splist <- read.csv(here::here(splist_filepath))
print(paste("Read in ", nrow(splist), "entries from checklist file", splist_filepath))

```



#### Interactions Data

To use a different or test interaction files, edit this L1 filename:

```{r}
intxns.db.file <- file.path(file_paths$L1,AvianInteractionData_L1_file)
intxns.db <-read.csv(here::here(intxns.db.file))
print(paste("read in ", nrow(intxns.db), "records from ", intxns.db.file))
```
#### Remove columns only relevant for non-NA species 

```{r}
intxns.db <- intxns.db %>% dplyr::select(-DatabaseSearchURL)
```


- get all interactions where either sp1 or sp2 is a species on the Canada/AK/CONUS list 
- subset out a few relevant columns in the splist for use with BBS network and spatial analysis

Use scientific_name_clements2024 as the match for names.
```{r}
length(unique(splist$scientific_name_clements2024)) #777
dim(splist) #785
dim(intxns.db)  #31040 (30776 in manual fix version)
# Some duplicate rows; these are just the unids. so we can ignore them
duplicate_indices <- duplicated(splist$scientific_name_clements2024)
duplicate_clements <- splist[duplicate_indices, ]
duplicate_clements

intxns.db.subset <- intxns.db[intxns.db$species1_scientific %in% splist$scientific_name_clements2024 | intxns.db$species2_scientific %in% splist$scientific_name_clements2024,]
dim(intxns.db.subset)  #26200 (25958 in manual fix version)

intxns.db.non.subset <- intxns.db[!(intxns.db$species1_scientific %in% splist$scientific_name_clements2024 | intxns.db$species2_scientific %in% splist$scientific_name_clements2024),]
dim(intxns.db.non.subset) #4818 in manual fix version
# Check that these equate to dim(intxns.db)
dim(intxns.db.non.subset)+dim(intxns.db.subset)
dim(intxns.db)  #30776 in manual fix version

usp1<-(unique(intxns.db.subset$species1_scientific))
usp2<-(unique(intxns.db.subset$species2_scientific))
usp1.2<-append(usp1,usp2)
length(unique(usp1.2)) #2137 unique species in the interaction data

# 2122 in manual fix version
# Create a simplified Clements/eBird BBS AOU combo splist:
splist<-splist %>%
      select(scientific_name_clements2024.combo, common_name_clements2024.combo,
             AOU_bbs2024.combo, scientific_name_clements2024, common_name_clements2024, 
             scientific_name_bbs2024, AOU_bbs2024, in_bbs2024)

```
Adjust nonbreeding season column @billspat note to move this to the L0 cleaning

```{r}
# List of characters to re-assign
old1 <- c("YSE", "YES", "Yes", "possibly", "potential", "yes")
new1 <- "nonbreeding"
# Re-assign values 
intxns.db.subset$nonbreedingseason <- ifelse(intxns.db.subset$nonbreedingseason %in% old1, new1, intxns.db.subset$nonbreedingseason)

old2 <- "breeding and nonbreeding"
new2 <- "breeding"
# Re-assign values 
intxns.db.subset$nonbreedingseason <- ifelse(intxns.db.subset$nonbreedingseason %in% old2, new2, intxns.db.subset$nonbreedingseason)

# Replace NA in 'nonbreedingseason' with "breeding"
intxns.db.subset$nonbreedingseason[is.na(intxns.db.subset$nonbreedingseason)] <- "breeding"

# Rename the column to 'season'
intxns.db.subset <- intxns.db.subset %>%
  rename(season = nonbreedingseason)

```



Assign all competition- to competition for this version (only a few of these exist; they will be kept specific in v2 of the data)

```{r}


## COMPETITION 

# List of characters to re-assign
old_comp <- c("competition-foraging","competition-nest site","competition-territory")
new_comp <- "competition"
# Re-assign values 
intxns.db.subset$interaction <- ifelse(intxns.db.subset$interaction %in% old_comp, 
                                       new_comp, 
                                       intxns.db.subset$interaction)


## KLEPTOPARASITISM

# List of characters to re-assign
old_klepto <- c("kleptoparasitism-food","kleptoparasitism-nest material")
new_klepto <- "kleptoparasitism"
# Re-assign values 
intxns.db.subset$interaction <- ifelse(intxns.db.subset$interaction %in% old_klepto, 
                                       new_klepto, 
                                       intxns.db.subset$interaction)



## FACILITATION

# List of characters to re-assign
old_facil<- c("facilitation-creching","facilitation-distress calls")
new_facil <- "facilitation"
# Re-assign values 
intxns.db.subset$interaction <- ifelse(intxns.db.subset$interaction %in% old_facil, 
                                       new_facil, 
                                       intxns.db.subset$interaction)



## PREDATION

# List of characters to re-assign
old_pred<- c("nest predation")
new_pred <- "predation"
# Re-assign values 
intxns.db.subset$interaction <- ifelse(intxns.db.subset$interaction %in% old_pred, 
                                       new_pred, 
                                       intxns.db.subset$interaction)



## MOBBING

# List of characters to re-assign
old_mob<- c("shared scolding")
new_mob <- "mobbing"
# Re-assign values 
intxns.db.subset$interaction <- ifelse(intxns.db.subset$interaction %in% old_mob, 
                                       new_mob, 
                                       intxns.db.subset$interaction)


# Generate summary table of interactions by type 
num_intxn_types <- intxns.db.subset %>% group_by(interaction) %>% summarize(n=n()) %>% arrange(-n) 
knitr::kable(num_intxn_types)
```

Create summary information in a table
```{r}
unique_counts_multi <- purrr::map_dfr(
      .x = c("interaction", "season"), 
      .f = ~ intxns.db.subset %>%
        count(!!sym(.x)) %>%
        mutate(Column = .x) %>%
        rename(Value = !!sym(.x), Count = n) %>%
        select(Column, Value, Count)
    )
# Nicer format
    knitr::kable(unique_counts_multi,
          caption = "Breeding and Non-breeding Data: Summaries",
          col.names = c("Column", "Value", "Count"),
          format = "markdown")
```

Version with only breeding season interactions:

```{r}
# Subset rows where 'season' is "breeding"
intxns.db.subset.breeding <- intxns.db.subset %>%
  filter(season == "breeding")
dim(intxns.db.subset.breeding) #23164 (22969 in fixed manual version)
dim(intxns.db.subset) #26200 (25958 in fixed manual version)

# Summary table
unique_counts_multi.b <- purrr::map_dfr(
      .x = c("interaction", "season"), 
      .f = ~ intxns.db.subset.breeding %>%
        count(!!sym(.x)) %>%
        mutate(Column = .x) %>%
        rename(Value = !!sym(.x), Count = n) %>%
        select(Column, Value, Count)
    )
# Nicer format
    knitr::kable(unique_counts_multi.b,
          caption = "Breeding Season Data: Summaries",
          col.names = c("Column", "Value", "Count"),
          format = "markdown")

```

Save the file with the file name defined in the OUTPUT section above
this has the current date embedded in it

```{r}

f <- file.path(file_paths$L1, AvianInteractionData_CanadaAKCONUS_L1_file )
write_csv(intxns.db.subset, f)
print(f)

fb <- file.path(file_paths$L1, AvianInteractionData_CanadaAKCONUS_breeding_file )
write_csv(intxns.db.subset.breeding, fb)
print(fb)

fx <- file.path(file_paths$L1, AvianInteractionData_L1_not_CanadaAKCONUS_file )
write_csv(intxns.db.non.subset, fx)
print(fx)

```

